name: Deploy to OpenStack VM

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        port: 22
        timeout: 30s
        script: |
          # Verificaci√≥n: Asegurar que MySQL externo est√© corriendo
          echo "üîç Verificando estado de MySQL..."
          if ! docker ps | grep -q mysql; then
            echo "‚ö†Ô∏è  MySQL no detectado. Intentando iniciar..."
            if [ -d "/home/ubuntu/mysql" ]; then
              cd /home/ubuntu/mysql
              docker compose up -d
              echo "‚è≥ Esperando 10s para que MySQL arranque..."
              sleep 10
            else
               echo "‚ùå Error: Carpeta /home/ubuntu/mysql no encontrada. No se puede iniciar BD."
            fi
          else
            echo "‚úÖ MySQL est√° corriendo."
          fi

          # Definir directorio (Hardcoded para evitar problemas con secrets)
          PROJECT_DIR="/home/ubuntu/miel-ia"

          echo "üìÇ Desplegando en: $PROJECT_DIR"
          
          # Crear directorio si no existe
          mkdir -p "$PROJECT_DIR"
          cd "$PROJECT_DIR"

          # Verificar si es un repo git, si no, clonar (First Deploy)
          if [ ! -d ".git" ]; then
            echo "üå± El directorio no es un repositorio Git. Clonando..."
            # Nota: Esto requiere que el repo sea p√∫blico o que haya credenciales configuradas
            git clone https://github.com/${{ github.repository }} .
          else
            echo "‚¨áÔ∏è Actualizando c√≥digo existente..."
            git pull origin main
          fi
          
          # Levantar contenedores
          docker compose up -d --build --remove-orphans
