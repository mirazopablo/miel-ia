name: Deploy to OpenStack VM

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        script: |
          # Verificaci√≥n: Asegurar que MySQL externo est√© corriendo
          echo "üîç Verificando estado de MySQL..."
          if ! docker ps | grep -q mysql; then
            echo "‚ö†Ô∏è  MySQL no detectado. Intentando iniciar..."
            # Asumimos ruta /home/ubuntu/mysql segun instruccion
            if [ -d "/home/ubuntu/mysql" ]; then
              cd /home/ubuntu/mysql
              docker compose up -d
              echo "‚è≥ Esperando 10s para que MySQL arranque..."
              sleep 10
            else
               echo "‚ùå Error: Carpeta /home/ubuntu/mysql no encontrada. No se puede iniciar BD."
               # No hacemos exit 1 para intentar deployar de todas formas,
               # pero idealmente aqu√≠ deber√≠a fallar si es critico.
            fi
          else
            echo "‚úÖ MySQL est√° corriendo."
          fi

          # Navegar al directorio del proyecto
          cd ${{ secrets.PROJECT_PATH }}
          
          # Descargar √∫ltimos cambios
          git pull origin main
          
          # Levantar/Reconstruir contenedores en modo detached (-d)
          # --build asegura que si cambi√≥ el Dockerfile se reconstruya
          docker compose up -d --build --remove-orphans
